<html>
<meta charset="UTF-8">
<head>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/index.css">
</head>
<body>

<div class="form-group">
  <label for="dtmsPersReportXslx">Choose the DTMS personnel file</label>
  <input type="file" id="dtmsPersReportXslx" name="dtmsPersReportXslx"/>
</div>

<div class="form-group">
  <label for="dtmsTngReportXslx">Choose the DTMS training report to process</label>
  <input type="file" id="dtmsTngReportXslx" name="dtmsTngReportXslx"/>
</div>

<div class="form-group">
  <label for="dtmsTngToTrackXslx">Choose the DTMS training to track</label>
  <input type="file" id="dtmsTngToTrackXslx" name="dtmsTngToTrackXslx"/>
</div>

<div class="form-group">
  <button id="displayUnitSize" type="button" class="btn btn-primary btn-lg">Display Unit Size</button>
  <button id="display350_1Compliance" type="button" class="btn btn-primary btn-lg">Display 350-1 Compliance</button>
</div>

<div class="chart"> </div> 
<div class="tngComplianceChart"> </div> 
<table id="complianceTable" class="table table-bordered" > </table> 
<table id="personTable" class="table table-bordered" > </table> 

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.csv.min.js"></script>
<script src="js/luxon.min.js"></script>
<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<script src="js/d3.v5.min.js"></script>

<script>
var DateTime = luxon.DateTime
var dtmsPersReport = []
var dtmsTngReport = []
var dtmsTngToTrack = []
var dtmsUnits = []
var unitTngRecords = []

// load the Xslx to create the dtmsPersReport, this is the personnel report from DTMS and contains information about unit personnel
$('#dtmsPersReportXslx').on('change', function(event) {
  var dtmsPersReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var data = e.target.result
    var workbook = XLSX.read(data, {
      type: 'binary'
    })
    workbook.SheetNames.forEach(function(sheetName) {
      dtmsPersReport = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    })
    dtmsUnits = processPersReport(dtmsPersReport)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsPersReportFile)
})

// load the Xslx to create the dtmsTngReport array, this file contains personnel training records
$('#dtmsTngReportXslx').on('change', function(event) {
  var dtmsTngReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var data = e.target.result
    var workbook = XLSX.read(data, {
      type: 'binary'
    })
    workbook.SheetNames.forEach(function(sheetName) {
      dtmsTngReport = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    })
    dtmsTngReport = addUnitToTngReport(dtmsTngReport, dtmsPersReport)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsTngReportFile)
})

// load the Xslx to create the dtmsTngToTrack - this is the list of trainings that will be displayed in the chart
$('#dtmsTngToTrackXslx').on('change', function(event) {
  var dtmsTngToTrackFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var data = e.target.result
    var workbook = XLSX.read(data, {
      type: 'binary'
    })
    // should be only 1 sheet for this document
    workbook.SheetNames.forEach(function(sheetName) {
      dtmsTngToTrack = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    })
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsTngToTrackFile)
})

// add the unitAssigned value to the training report data structure 
function addUnitToTngReport (dtmsTngReport, dtmsPersReport) {
  dtmsTngReport.forEach(function(record) {
    dtmsPersReport.forEach(function(person) {
      if(record.LastName == person.LastName && record.Last4 == person.Last4) {
        record['UnitAssigned'] = person['UnitAssigned']
      }  
    })
  })
  return dtmsTngReport
}

// build a data structure that contains the training data
function calcTngCompliance (dtmsTngReport) {
  // make acopy of the dtmsUnits array, this makes a shallow copy
  unitTngRecords = [...dtmsUnits]
  var allTngs = []
  unitTngRecords.forEach(function(unitRecord) {
    unitRecord['tngData'] = {}
  })
  // combine each person's record to one snapshot

  // want to list the snapshot by unit by training
  dtmsTngReport.forEach(function(record) {
    let unit = record['UnitAssigned']
    unitTngRecords.forEach(function(unitRecord) {
      if (unit == unitRecord['unit']) {
        // the task doesn't exist for that unit, add it
        if (!unitRecord['tngData'].hasOwnProperty(record.TaskNumber)) {
          unitRecord['tngData'][record.TaskNumber] = []
          // do not add this extra record now, other ways will be used to document the frequency of the training
          //unitRecord['tngData'][record.TaskNumber].push({ required: unitRecord.count, frequency: 365 })
        }
        // convert the date to a luxon date
        // LastDateTrained is in format 'M/D/YY'
        dateData = record['LastDateTrained'].split('/')
        tngDate = new DateTime.utc(parseInt('20' + dateData[2]), parseInt(dateData[0]), parseInt(dateData[1]))
        unitRecord['tngData'][record.TaskNumber].push({ tng: record.TaskNumber, rank: record.RankShort, LastName: record.LastName, Last4: record.Last4, tngDate: tngDate })
      }
    })
  })
  return unitTngRecords
}

function processPersReport (dtmsPersReport) {
  // count the unit size, also break down how many people by rank are in each unit
  // unitPersStats
  //  { 
  //    unit: UNIT_NAME,
  //    persCount: number,
  //    soldierCount: number,
  //    civilianCount: number,
  //    rankArray: [ {rank: count}, {rank: count}... ]
  //  }
  // iterate through the dtmsPersReport and print out unique units with a count of how many are in the unit

  // do two passes through the dtmsPersReport, on the first pass, get an array of all the different ranks inside the report
  let rankArray = []
  dtmsPersReport.forEach(function(person) {
    if(!rankArray.includes(person['RankShort'])) {
      rankArray.push(person['RankShort'])
    }
  })
  let rankArrayWithCount = []
  rankArray.forEach(function(rankVal) {
    rankArrayWithCount.push({ rank: rankVal, rankCount: 0 })
  })
  dtmsPersReport.forEach(function(person) {
    // if the unit doesn't exist in the array, add it with empty numbers
    if(!unitExists(person['UnitAssigned'])) {
      let unitRankArray = rankArrayWithCount.map(a => ({...a}))
      dtmsUnits.push(
        { 
          unit: person['UnitAssigned'], 
          persCount: 0,
          soldierCount: 0,
          civilianCount: 0,
          rankArray: unitRankArray
        })
    } 
    dtmsUnits.forEach(function(dtmsUnit) {
      // if the person's UnitAssigned matches the current unit
      // increment the persCount
      // check if they're a Soldier or Civilian, increment the count accordingly
      if (dtmsUnit['unit'] == person['UnitAssigned']) {
        dtmsUnit.persCount++
        // if there is a 'GS' in the person's rank, they are a civilian
        if (person['RankShort'].indexOf('GS') >= 0) {
          dtmsUnit.civilianCount++
        }
        // if there is no 'GS' in the person's rank, they are a soldier
        if (person['RankShort'].indexOf('GS') == -1) {
          dtmsUnit.soldierCount++
        }
        unitRankArray = dtmsUnit['rankArray']
        // add 1 to the rankCount for the person's rank
        for (let j = 0; j < unitRankArray.length; j++) {
          if (unitRankArray[j]['rank'] === person['RankShort']) {
            unitRankArray[j]['rankCount']++
          }
        }
      }
    })
  })
  // sort the units by name alphabetically
  dtmsUnits = sortByUnit(dtmsUnits)
  return dtmsUnits
}

// count the personnel by unit
$('#displayUnitSize').on('click', function () {
  var scale = d3.scaleLinear()
    .domain([0,39])
    .range([0,600])

  d3.select(".chart")
    .selectAll("div")
    .data(dtmsUnits)
      .enter()
      .append("div")
      .style("width", function(d) { return scale(d.persCount) + 'px' })
      .text(function(d) { return d.unit + " Personnel: " + d.persCount })
})

// TODO - print out unit personnel

// print out the unit's percent compliance with each of the trainings listed in the training to track file
// make an easier way to view this information

// create a data structure that contains the units required training along with the numbers that they should have

// first sort the record
// by team, by person
$('#display350_1Compliance').on('click', function () {
  // calculate the training compliance for the dtmsTngReport
  // unitTngRecords contains the trainign data broken down by unit
  unitTngRecords = calcTngCompliance(dtmsTngReport)

  // this function will build the html table to show the training data
  generate350_1Table(unitTngRecords, dtmsTngToTrack)
})

function generate350_1Table (unitTngRecords, dtmsTngToTrack) {
  var complianceTable = document.getElementById('complianceTable')
  // remove the current table
  while(complianceTable.hasChildNodes()) {
     complianceTable.removeChild(complianceTable.firstChild);
  }

  // setup the header, get the trainings that need to be displayed
  var headerRowName = complianceTable.insertRow(-1)
  var headerRowNumber = complianceTable.insertRow(-1)
  var headerCellName = headerRowName.insertCell(-1)
  var headerCellNumber = headerRowNumber.insertCell(-1)
  dtmsTngToTrack.forEach(function(tngEntry) {
    headerCellName = headerRowName.insertCell(-1)
    headerCellName.innerHTML = tngEntry['TaskName']
    headerCellNumber = headerRowNumber.insertCell(-1)
    headerCellNumber.innerHTML = tngEntry['TaskNumber']
  })

  unitTngRecords.forEach(function(unitRecord) {
    var unitRow = complianceTable.insertRow(-1)
    var unitCell = unitRow.insertCell(-1)
    unitCell.innerHTML = unitRecord['unit']
    dtmsTngToTrack.forEach(function(tngEntry) {
      unitCell = unitRow.insertCell(-1)
      let data = getUnitCompliance(tngEntry['TaskNumber'], unitRecord['unit'], tngEntry['Audience'])
      // set the chart up here
      setCellCompliance(unitCell, data)
      unitCell.onclick = (function() { 
        genAndShowTngList(tngEntry['TaskNumber'], unitRecord['unit']) 
      })
    })
  })
}

function generateTngList (tng, unit) {
  // iterate through and display who is compliant and who is not compliant with that training
  let personRecords = []

  dtmsPersReport.forEach(function(personRecord) {
    if (personRecord['UnitAssigned'] === unit) {
      personRecords.push(personRecord)
    }
  })
  dtmsTngReport.forEach(function(record) {
    personRecords.forEach(function(person) {
      if (record['TaskNumber'] === tng && record['Last4'] === person['Last4'] && record['LastName'] === person['LastName']) {
        person['LastDateTrained'] = record['LastDateTrained']
        person['TaskNumber'] = record['TaskNumber']
      }
    })
  })
  return personRecords
}

function genAndShowTngList(tng, unit) {
  let personRecords = generateTngList(tng, unit)
  showTngList(personRecords)
}


function showTngList (personRecords) {
  var personTable = document.getElementById('personTable')
  // remove the current table
  while(personTable.hasChildNodes()) {
     personTable.removeChild(personTable.firstChild);
  }
  let headerRow = personTable.insertRow(-1)
  let rankHeaderCell = headerRow.insertCell(-1)
  rankHeaderCell.innerHTML = 'Rank'
  let nameHeaderCell = headerRow.insertCell(-1)
  nameHeaderCell.innerHTML = 'Name'
  let tngHeaderCell = headerRow.insertCell(-1)
  tngHeaderCell.innerHTML = 'Training'
  let tngDateHeaderCell = headerRow.insertCell(-1)
  tngDateHeaderCell.innerHTML = 'Date Trained'
  personRecords.forEach(function(person) {
    let personRow = personTable.insertRow(-1)
    let personRankCell = personRow.insertCell(-1)
    let personNameCell = personRow.insertCell(-1)
    let personTngCell = personRow.insertCell(-1)
    let personTngDateCell = personRow.insertCell(-1)
    personRankCell.innerHTML = person.RankShort
    personNameCell.innerHTML = person.LastName
    if (person.TaskNumber !== undefined) { 
      personTngCell.innerHTML = person.TaskNumber
    } else {
      personTngCell.innerHTML = ''
    }
    if (person.LastDateTrained !== undefined) {
      personTngDateCell.innerHTML = person.LastDateTrained
    } else {
      personTngDateCell.innerHTML = ''
    }
  })
}

function setCellCompliance (cell, values) {
  let compliant = parseInt(values.compliant)
  let total = parseInt(values.compliant) + parseInt(values.noncompliant)
  let compliance = Math.round(100 * compliant / total)
  cell.innerHTML = compliance + '%<br>' + compliant + '/' + total

  if(compliance < 70) {
    cell.bgColor = 'red'
    cell.style.color = 'white'
  } else if (compliance < 80) {
    cell.bgColor = 'yellow'
    cell.style.color = 'black'
  } else {
    cell.bgColor = 'green'
    cell.style.color = 'black'
  }
}

function getUnitCompliance(tng, unit, audience) {
  // total the number of people that have completed the training, return an
  // object { compliant: VALUE, noncompliant: VALUE }
  var personRecords = []
  var peopleInUnit = 0
  unitTngRecords.forEach(function(unitRecord) {
    if (unit === unitRecord['unit']) {
      personRecords = unitRecord['tngData'][tng] || []
      peopleInUnit = unitRecord['persCount']
    }
  })
  // TODO first sort the array by the date of the training to ensure that the most recent training is highest
  // remove duplicates from the 'personReocrds' field
  var dedupPersonRecords = []
  const map = new Map()
  for (const item of personRecords) {
    if(!map.has(item.Last4)) {
      map.set(item.Last4, true)
      dedupPersonRecords.push({
            LastName: item.LastName,
            Last4: item.Last4
      })
    }
  }
  // need to make sure there are no duplicate records in the future
  try {
    var compliant = dedupPersonRecords.length
  } catch (e) {
    compliant = 0
  }
  // 4 cases
  // 1 - all -> just use 'peopleInUnit'
  // 2 - Soldiers -> subtrack civilians from people in unit
  // 3 - Civilians -> use the civilians number
  // 4 - Supervisors -> hard code in '2' at this time

  var required = peopleInUnit

  if (audience === 'All') {
    required = peopleInUnit
  } else if (audience === 'Soldiers') {
    var unitSoldierCount = getSoldierCount(unit)
    required = unitSoldierCount
  } else if (audience === 'Civilians') {
    var unitCivilianCount = getCivilianCount(unit)
    required = unitCivilianCount
  } else if (audience === 'Supervisors') {
    required = 2
  } else {
    required = peopleInUnit
  }

  let noncompliant = 0
  if (required - compliant > 0) {
    noncompliant = required - compliant
  }
  // TODO - check to make sure that those that are required to take a training are the ones that completed it
  return { compliant: compliant, noncompliant: noncompliant }
}

function getSoldierCount (unit) {
  var soldierCount = 0
  dtmsUnits.forEach(function(dtmsUnit) {
    if (dtmsUnit['unit'] === unit) {
      soldierCount = dtmsUnit['soldierCount']
    }
  })
  return soldierCount
}

function getCivilianCount (unit) {
  var civilianCount = 0
  dtmsUnits.forEach(function(dtmsUnit) {
    if (dtmsUnit['unit'] === unit) {
      civilianCount = dtmsUnit['civilianCount']
    }
  })
  return civilianCount
}

// sort by the date column descending (newest value on the top)
function sortByDateDesc (sort_file) {
  // sort by the unit
  sort_file.sort( function(a, b) {
    return (a.unit.localeCompare(b.unit))
  })
  return sort_file
}

function sortByUnit (sort_file) {
  // sort by the unit
  sort_file.sort( function(a, b) {
    return (a.unit.localeCompare(b.unit))
  })
  return sort_file
}

function unitExists(unitName) {
  return dtmsUnits.some(function(el) {
    return el.unit === unitName
  })  
}
</script>
</body>
</html>
