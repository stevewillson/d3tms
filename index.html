<html>
<meta charset="UTF-8">
<head>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/index.css">
</head>
<body>

<div class="form-group">
  <label for="dtmsPersReportXslx">Choose the DTMS personnel file</label>
  <input type="file" id="dtmsPersReportXslx" name="dtmsPersReportXslx"/>
</div>

<div class="form-group">
  <label for="dtmsTngReportXslx">Choose the DTMS training report to process</label>
  <input type="file" id="dtmsTngReportXslx" name="dtmsTngReportXslx"/>
</div>

<div class="form-group">
  <label for="dtmsTngToTrackXslx">Choose the DTMS training to track</label>
  <input type="file" id="dtmsTngToTrackXslx" name="dtmsTngToTrackXslx"/>
</div>

<div class="form-group">
  <button id="displayUnitSize" type="button" class="btn btn-primary btn-lg">Display Unit Size</button>
  <button id="display350_1Compliance" type="button" class="btn btn-primary btn-lg">Display 350-1 Compliance</button>
</div>

<div class="chart"> </div> 
<div class="tngComplianceChart"> </div> 
<table id="complianceTable" class="table table-bordered" > </table> 
<table id="personTable" class="table table-bordered" > </table> 

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.csv.min.js"></script>
<script src="js/luxon.min.js"></script>
<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<script src="js/d3.v5.min.js"></script>

<script>
var DateTime = luxon.DateTime
var dtmsPersReport = []
var dtmsTngReport = []
var dtmsTngToTrack = []
var dtmsUnits = []

// create the dtmsPersReport from the Xslx file
// this is the personnel report from DTMS
$('#dtmsPersReportXslx').on('change', function(event) {
  var dtmsPersReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var data = e.target.result
    var workbook = XLSX.read(data, {
      type: 'binary'
    })
    dtmsPersReport = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

    dtmsUnits = processPersReport(dtmsPersReport)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsPersReportFile)
})

// create the dtmsTngReport from the Xslx file
// this contains personnel training records
$('#dtmsTngReportXslx').on('change', function(event) {
  var dtmsTngReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var data = e.target.result
    var workbook = XLSX.read(data, {
      type: 'binary'
    })
    dtmsTngReport = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
    // sort by date trained and remove duplicate person entries from the tng report
    // only interested in the latest date trained

    dtmsTngReport.forEach(function(tngRecord) {
      dateData = tngRecord['LastDateTrained'].split('/')
      tngDate = new DateTime.utc(parseInt('20' + dateData[2]), parseInt(dateData[0]), parseInt(dateData[1]))
      tngRecord['parsedLastDateTrained'] = tngDate
    })

    // sort the training by the date completed
    let dtmsTngReportSorted = sortByDateDesc(dtmsTngReport)

    // deduplicate the training records by person and tasknumber
    let dtmsTngReportSortedDedup = dedupTngRecords(dtmsTngReportSorted)

    // add the unit to the training for showing unit compliance
    dtmsTngReport = addUnitToTngReport(dtmsTngReportSortedDedup, dtmsPersReport)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsTngReportFile)
})

// load the Xslx to create the dtmsTngToTrack - this is the list of trainings that will be displayed in the chart
$('#dtmsTngToTrackXslx').on('change', function(event) {
  let dtmsTngToTrackFile = event.target.files[0]
  let reader = new FileReader()
  reader.onload = function (e) {
    let data = e.target.result
    let workbook = XLSX.read(data, {
      type: 'binary'
    })
    dtmsTngToTrack = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsTngToTrackFile)
})

// add the unitAssigned value to the training report data structure 
function addUnitToTngReport (dtmsTngReport, dtmsPersReport) {
  dtmsTngReport.forEach(function(record) {
    dtmsPersReport.forEach(function(person) {
      if(record.LastName == person.LastName && record.Last4 == person.Last4) {
        record['UnitAssigned'] = person['UnitAssigned']
      }  
    })
  })
  return dtmsTngReport
}

// build a data structure that contains the training data
function calcTngCompliance (dtmsUnits, dtmsTngReport) {
  dtmsUnits.forEach(function(unitRecord) {
    unitRecord['tngData'] = {}
  })
  // combine each person's record to one snapshot

  // want to list the snapshot by unit by training
  dtmsTngReport.forEach(function(record) {
    let unit = record['UnitAssigned']
    dtmsUnits.forEach(function(unitRecord) {
      if (unit == unitRecord['unit']) {
        // the task doesn't exist for that unit, add it
        if (!unitRecord['tngData'].hasOwnProperty(record.TaskNumber)) {
          unitRecord['tngData'][record.TaskNumber] = []
        }
        // convert the date to a luxon date
        // LastDateTrained is in format 'M/D/YY'
        dateData = record['LastDateTrained'].split('/')
        tngDate = new DateTime.utc(parseInt('20' + dateData[2]), parseInt(dateData[0]), parseInt(dateData[1]))
        unitRecord['tngData'][record.TaskNumber].push({ tng: record.TaskNumber, rank: record.RankShort, LastName: record.LastName, Last4: record.Last4, tngDate: tngDate })
      }
    })
  })
  return dtmsUnits
}

function processPersReport (dtmsPersReport) {
  // count the unit size, also break down how many people by rank are in each unit
  // unitPersStats
  //  { 
  //    unit: UNIT_NAME,
  //    persCount: number,
  //    soldierCount: number,
  //    civilianCount: number,
  //    rankArray: [ {rank: count}, {rank: count}... ]
  //  }
  // iterate through the dtmsPersReport and print out unique units with a count of how many are in the unit

  // do two passes through the dtmsPersReport, on the first pass, get an array of all the different ranks inside the report
  let rankArray = []
  dtmsPersReport.forEach(function(person) {
    if(!rankArray.includes(person['RankShort'])) {
      rankArray.push(person['RankShort'])
    }
  })
  let rankArrayWithCount = []
  rankArray.forEach(function(rankVal) {
    rankArrayWithCount.push({ rank: rankVal, rankCount: 0 })
  })
  dtmsPersReport.forEach(function(person) {
    // if the unit doesn't exist in the array, add it with empty numbers
    if(!unitExists(person['UnitAssigned'])) {
      let unitRankArray = rankArrayWithCount.map(a => ({...a}))
      dtmsUnits.push(
        { 
          unit: person['UnitAssigned'], 
          persCount: 0,
          soldierCount: 0,
          civilianCount: 0,
          rankArray: unitRankArray
        })
    } 
    dtmsUnits.forEach(function(dtmsUnit) {
      // if the person's UnitAssigned matches the current unit
      // increment the persCount
      // check if they're a Soldier or Civilian, increment the count accordingly
      if (dtmsUnit['unit'] === person['UnitAssigned']) {
        dtmsUnit.persCount++
        // if there is a 'GS' in the person's rank, they are a civilian
        if (person['RankShort'].indexOf('GS') >= 0) {
          dtmsUnit.civilianCount++
        }
        // if there is no 'GS' in the person's rank, they are a soldier
        if (person['RankShort'].indexOf('GS') == -1) {
          dtmsUnit.soldierCount++
        }
        unitRankArray = dtmsUnit['rankArray']
        // add 1 to the rankCount for the person's rank
        for (let j = 0; j < unitRankArray.length; j++) {
          if (unitRankArray[j]['rank'] === person['RankShort']) {
            unitRankArray[j]['rankCount']++
          }
        }
      }
    })
  })
  // sort the units by name alphabetically
  dtmsUnits = sortByUnit(dtmsUnits)
  return dtmsUnits
}

function getUnitKeyValue(unit, key) {
  // for the dtmsUnits data structure, return the value for the key 'key' for the unit 'unit'
  let retValue = ''
  dtmsUnits.forEach(function(dtmsUnit) {
    if (dtmsUnit['unit'] === unit) {
      retValue = dtmsUnit[key]
      return retValue
    }
  })
  return retValue
}

// count the personnel by unit
$('#displayUnitSize').on('click', function () {
  var scale = d3.scaleLinear()
    .domain([0,39])
    .range([0,600])

  d3.select(".chart")
    .selectAll("div")
    .data(dtmsUnits)
      .enter()
      .append("div")
      .style("width", function(d) { return scale(d.persCount) + 'px' })
      .text(function(d) { return d.unit + " Personnel: " + d.persCount })
})

// TODO - print out unit personnel

// print out the unit's percent compliance with each of the trainings listed in the training to track file
// make an easier way to view this information

// by team, by person
$('#display350_1Compliance').on('click', function () {
  // calculate the training compliance for the dtmsTngReport
  // dtmsUnits contains the trainign data broken down by unit
  dtmsUnits = calcTngCompliance(dtmsUnits, dtmsTngReport)

  // this function will build the html table to show the training data
  generate350_1Table(dtmsUnits, dtmsTngToTrack)
})

// replace the unit TngRecords with the dtmsUnits

function generate350_1Table (dtmsUnits, dtmsTngToTrack) {
  var complianceTable = document.getElementById('complianceTable')
  // remove the current table
  while(complianceTable.hasChildNodes()) {
     complianceTable.removeChild(complianceTable.firstChild);
  }

  // setup the header, get the trainings that need to be displayed
  var headerRowName = complianceTable.insertRow(-1)
  var headerRowNumber = complianceTable.insertRow(-1)
  var headerCellName = headerRowName.insertCell(-1)
  var headerCellNumber = headerRowNumber.insertCell(-1)
  headerCellName.innerHTML = 'Task Name'
  headerCellNumber.innerHTML = 'Task Number'
  dtmsTngToTrack.forEach(function(tngEntry) {
    headerCellName = headerRowName.insertCell(-1)
    headerCellName.innerHTML = tngEntry['TaskName']
    headerCellNumber = headerRowNumber.insertCell(-1)
    headerCellNumber.innerHTML = tngEntry['TaskNumber']
  })

  dtmsUnits.forEach(function(unitRecord) {
    var unitRow = complianceTable.insertRow(-1)
    var unitCell = unitRow.insertCell(-1)
    unitCell.innerHTML = unitRecord['unit']
    unitCell.onclick = (function() { 
      displayPersonnelCompliance(unitRecord['unit']) 
    })
    dtmsTngToTrack.forEach(function(tngEntry) {
      unitCell = unitRow.insertCell(-1)
      let data = getUnitCompliance(tngEntry['TaskNumber'], unitRecord['unit'], tngEntry['Audience'])
      // set the chart up here
      setCellCompliance(unitCell, data)
      unitCell.onclick = (function() { 
        genAndShowTngList(tngEntry['TaskNumber'], unitRecord['unit']) 
      })
    })
  })
}

function generateTngList (tng, unit) {
  // iterate through and display who is compliant and who is not compliant with that training
  let personRecords = []
  let tngRecords = []
  let personTngRecords = []

  // make an array of the 'personRecords' that apply to this unit
  dtmsPersReport.forEach(function(personRecord) {
    // build an array of all the people assigned
    if (personRecord['UnitAssigned'] === unit) {
      personRecords.push(personRecord)
    }
  })
  // make an array of the 'tngRecords' that apply to this training
  dtmsTngReport.forEach(function(tngRecord) {
    if (tngRecord['TaskNumber'] === tng) {
      tngRecords.push(tngRecord)
    }
  })

  // make a copy of the objects for the personTngRecords array
  personTngRecords = personRecords.map(a => ({...a}))

  personTngRecords.forEach(function(person) {
    tngRecords.forEach(function(record) {
      // all records have the 'TaskNumber' of tng that we are interested in, just look to place the correct values by the person's name
      // while looping through each tngRecord, check to see if the person's name and last4 are in that record
      // if yes, then add the training to the 'personTngRecords' array
      if (record['Last4'] === person['Last4'] && record['LastName'] === person['LastName']) {
        person['LastDateTrained'] = record['LastDateTrained']
        person['TaskNumber'] = record['TaskNumber']
        person['parsedLastDateTrained'] = record['parsedLastDateTrained']
      }
    })
  })
  return personTngRecords
}

function genAndShowTngList(tng, unit) {
  let personRecords = generateTngList(tng, unit)
  showTngList(personRecords)
}


function showTngList (personRecords) {
  let personTable = document.getElementById('personTable')
  // remove the current table
  while(personTable.hasChildNodes()) {
     personTable.removeChild(personTable.firstChild);
  }
  let headerRow = personTable.insertRow(-1)
  let rankHeaderCell = headerRow.insertCell(-1)
  rankHeaderCell.innerHTML = 'Rank'
  let nameHeaderCell = headerRow.insertCell(-1)
  nameHeaderCell.innerHTML = 'Name'
  let tngHeaderCell = headerRow.insertCell(-1)
  tngHeaderCell.innerHTML = 'Task Number'
  let tngDateHeaderCell = headerRow.insertCell(-1)
  tngDateHeaderCell.innerHTML = 'Date Trained'
  personRecords.forEach(function(person) {
    let personRow = personTable.insertRow(-1)
    let personRankCell = personRow.insertCell(-1)
    let personNameCell = personRow.insertCell(-1)
    let personTngCell = personRow.insertCell(-1)
    let personTngDateCell = personRow.insertCell(-1)
    personRankCell.innerHTML = person.RankShort
    personNameCell.innerHTML = person.LastName
    if (person.TaskNumber !== undefined) { 
      personTngCell.innerHTML = person.TaskNumber
    } else {
      personTngCell.innerHTML = ''
    }
    if (person.LastDateTrained !== undefined) {
      personTngDateCell.innerHTML = person.LastDateTrained
    } else {
      personTngDateCell.innerHTML = ''
    }
  })
}

function setCellCompliance (cell, values) {
  let compliant = parseInt(values.compliant)
  let total = parseInt(values.compliant) + parseInt(values.noncompliant)
  let compliance = Math.round(100 * compliant / total)
  cell.innerHTML = compliance + '%<br>' + compliant + '/' + total

  if(compliance < 70) {
    cell.bgColor = 'red'
    cell.style.color = 'white'
  } else if (compliance < 80) {
    cell.bgColor = 'yellow'
    cell.style.color = 'black'
  } else {
    cell.bgColor = 'green'
    cell.style.color = 'black'
  }
}

function getUnitCompliance(tng, unit, audience) {
  // total the number of people that have completed the training, return an
  // object { compliant: VALUE, noncompliant: VALUE }
  var personRecords = []
  var peopleInUnit = 0
  peopleInUnit = getUnitKeyValue(unit, 'persCount')
  personRecords = getUnitKeyValue(unit, 'tngData')[tng] || []
  // remove duplicate records
  var dedupPersonRecords = []
  const map = new Map()
  for (const item of personRecords) {
    if(!map.has(item.Last4)) {
      map.set(item.Last4, true)
      dedupPersonRecords.push({
            LastName: item.LastName,
            Last4: item.Last4
      })
    }
  }
  try {
    var compliant = dedupPersonRecords.length
  } catch (e) {
    compliant = 0
  }
  // 4 cases
  // 1 - all -> just use 'peopleInUnit'
  // 2 - Soldiers -> subtrack civilians from people in unit
  // 3 - Civilians -> use the civilians number
  // 4 - Supervisors -> hard code in '2' at this time

  var required = peopleInUnit

  if (audience === 'All') {
    required = peopleInUnit
  } else if (audience === 'Soldiers') {
    var unitSoldierCount = getUnitKeyValue(unit, 'soldierCount')
    required = unitSoldierCount
  } else if (audience === 'Civilians') {
    var unitCivilianCount = getUnitKeyValue(unit, 'civilianCount')
    required = unitCivilianCount
  } else if (audience === 'Supervisors') {
    required = 2
  } else {
    required = peopleInUnit
  }

  let noncompliant = 0
  if (required - compliant > 0) {
    noncompliant = required - compliant
  }
  // TODO - check to make sure that those that are required to take a training are the ones that completed it
  return { compliant: compliant, noncompliant: noncompliant }
}

function displayPersonnelCompliance (unit) {
  // given a unit, display the people in that unit and when they completed the tracked training, display 'red' background if they do not have a training record
  // loop through all the personnel
  let personTable = document.getElementById('personTable')
  // remove the current table
  while(personTable.hasChildNodes()) {
     personTable.removeChild(personTable.firstChild);
  }
  // setup the header, get the trainings that need to be displayed
  let headerRowName = personTable.insertRow(-1)
  let headerRowNumber = personTable.insertRow(-1)
  let headerCellName = headerRowName.insertCell(-1)
  let headerCellNumber = headerRowNumber.insertCell(-1)
  headerCellName.innerHTML = 'Task Name'
  headerCellNumber.innerHTML = 'Task Number'
  dtmsTngToTrack.forEach(function(tngEntry) {
    headerCellName = headerRowName.insertCell(-1)
    headerCellName.innerHTML = tngEntry['TaskName']
    headerCellNumber = headerRowNumber.insertCell(-1)
    headerCellNumber.innerHTML = tngEntry['TaskNumber']
  })
  dtmsPersReport.forEach(function(person) {
    if (person['UnitAssigned'] === unit) {
      displayPersonTraining(person)
    }
  })
}

function displayPersonTraining (person) {
  let personTable = document.getElementById('personTable')

  let persHeaderRow = personTable.insertRow(-1)
  let persHeaderCell = persHeaderRow.insertCell(-1)
  let dateData = ''
  persHeaderCell.innerHTML = person['LastName']
  dtmsTngToTrack.forEach(function(tngToTrack) {
    personCell = persHeaderRow.insertCell(-1)
    dtmsTngReport.forEach(function(tngRecord) {
      // also check to see if the person's name matches
      if(tngToTrack['TaskNumber'] === tngRecord['TaskNumber'] && person['Last4'] === tngRecord['Last4'] && person['LastName'] === tngRecord['LastName']) {
        // parse the date and then show the box 
        // green - good to go
        // yellow - will expire in the next 30 days
        // red - expired or no record found
        dateData = tngRecord['LastDateTrained'].split('/')
        tngDate = new DateTime.utc(parseInt('20' + dateData[2]), parseInt(dateData[0]), parseInt(dateData[1]))
        //let tngRecord['parsedLastDateTrained'] = tngDate
        personCell.innerHTML = tngRecord['LastDateTrained']

        //// compare the dates
        //if(DateTime().valueOf() > tngDate.plus({ year: 1 }).valueOf()) {
          //persComplianceCell.bgColor = 'red'
        //}
      }
    })
  })
}

function dedupTngRecords (tngRecords) {
  // iterate through the array of records, add the records to the 'dedupRecords' object and return an array of unique records
  // uniqueify by LastName, Last4, TaskNumber
  let dedupTngRecords = []

  // make an array that holds our values of interest, we will concatenate the LastName, Last4, and TaskNumber to make our 'flat array' and check against that array to see
  // if the value already exists in that array
  let dedupCheckArray = []

  tngRecords.forEach(function(tngRecord) {
    // if the dedupCheckArray doesn't contain the entry, it is the first time that it has been seen! unique
    if (dedupCheckArray.indexOf((tngRecord['LastName'] + tngRecord['Last4'] + tngRecord['TaskNumber'])) == -1) {
      dedupCheckArray.push(tngRecord['LastName'] + tngRecord['Last4'] + tngRecord['TaskNumber'])
      dedupTngRecords.push(tngRecord)
    }
  })
  return dedupTngRecords
}


// SORT FUNCTIONS 

// sort by the date column descending (newest value on the top)
function sortByDateDesc (sort_file) {
  // sort by the unit
  sort_file.sort( function(a, b) {
    if (a.parsedLastDateTrained.valueOf() > b.parsedLastDateTrained.valueOf()) { 
      return -1
    } else if (a.parsedLastDateTrained.valueOf() < b.parsedLastDateTrained.valueOf()) { 
      return 1 
    } else {
      return 0
    }
  })
  return sort_file
}

function sortByUnit (sort_file) {
  // sort by the unit
  sort_file.sort( function(a, b) {
    return (a.unit.localeCompare(b.unit))
  })
  return sort_file
}

function unitExists(unitName) {
  return dtmsUnits.some(function(el) {
    return el.unit === unitName
  })  
}
</script>
</body>
</html>
