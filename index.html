<html>
<meta charset="UTF-8">
<head>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/index.css">
</head>
<body>

<div class="form-group">
  <label for="dtmsPersReportXslx">Choose the DTMS personnel file</label>
  <input type="file" id="dtmsPersReportXslx" name="dtmsPersReportXslx"/>
</div>

<div class="form-group">
  <label for="dtmsTngReportXslx">Choose the DTMS training report to process</label>
  <input type="file" id="dtmsTngReportXslx" name="dtmsTngReportXslx"/>
</div>

<div class="form-group">
  <label for="dtmsTngToTrackXslx">Choose the DTMS training to track</label>
  <input type="file" id="dtmsTngToTrackXslx" name="dtmsTngToTrackXslx"/>
</div>

<div class="form-group">
  <button id="displayUnitSize" type="button" class="btn btn-primary btn-lg">Display Unit Size</button>
  <button id="display350_1Compliance" type="button" class="btn btn-primary btn-lg">Display 350-1 Compliance</button>
</div>

<div class="chart"> </div> 
<div class="tngComplianceChart"> </div> 
<table id="complianceTable" class="table table-bordered" > </table> 
<table id="personTable" class="table table-bordered" > </table> 

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.csv.min.js"></script>
<script src="js/luxon.min.js"></script>
<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<script src="js/d3.v5.min.js"></script>

<script>
var DateTime = luxon.DateTime
var dtmsPersReport = []
var dtmsTngReport = []
var dtmsTngToTrack = []
var dtmsUnits = []
var unitTngRecords = []

// load the Xslx to create the dtmsPersReport
$('#dtmsPersReportXslx').on('change', function(event) {
  var dtmsPersReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var data = e.target.result
    var workbook = XLSX.read(data, {
      type: 'binary'
    })
    workbook.SheetNames.forEach(function(sheetName) {
      dtmsPersReport = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    })
    dtmsUnits = processPersReport(dtmsPersReport)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsPersReportFile)
})

// load the Xslx to create the dtmsTngReport
$('#dtmsTngReportXslx').on('change', function(event) {
  var dtmsTngReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var data = e.target.result
    var workbook = XLSX.read(data, {
      type: 'binary'
    })
    workbook.SheetNames.forEach(function(sheetName) {
      dtmsTngReport = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    })
    dtmsTngReport = addUnitToTngReport(dtmsTngReport, dtmsPersReport)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsTngReportFile)
})


// load the Xslx to create the dtmsTngToTrack - this is the list of trainings that we care about
$('#dtmsTngToTrackXslx').on('change', function(event) {
  var dtmsTngToTrackFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var data = e.target.result
    var workbook = XLSX.read(data, {
      type: 'binary'
    })
    // should be only 1 sheet for this document
    workbook.SheetNames.forEach(function(sheetName) {
      dtmsTngToTrack = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    })
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsBinaryString(dtmsTngToTrackFile)
})

// add the unitAssigned value to the training report data structure 
function addUnitToTngReport (dtmsTngReport, dtmsPersReport) {
  dtmsTngReport.forEach(function(record) {
    dtmsPersReport.forEach(function(person) {
      if(record.LastName == person.LastName && record.Last4 == person.Last4) {
        record['UnitAssigned'] = person['UnitAssigned']
      }  
    })
  })
  return dtmsTngReport
}

// build a data structure that contains the training data
function calcTngCompliance (dtmsTngReport) {
  // make acopy of the dtmsUnits array, this makes a shallow copy
  unitTngRecords = [...dtmsUnits]
  var allTngs = []
  unitTngRecords.forEach(function(unitRecord) {
    unitRecord['tngData'] = {}
  })
  // combine each person's record to one snapshot

  // want to list the snapshot by unit by training
  dtmsTngReport.forEach(function(record) {
    let unit = record['UnitAssigned']
    unitTngRecords.forEach(function(unitRecord) {
      if (unit == unitRecord['unit']) {
        // the task doesn't exist for that unit, add it
        if (!unitRecord['tngData'].hasOwnProperty(record.TaskNumber)) {
          unitRecord['tngData'][record.TaskNumber] = []
          unitRecord['tngData'][record.TaskNumber].push({ required: unitRecord.count, frequency: 365 })
        }
        unitRecord['tngData'][record.TaskNumber].push({ tng: record.TaskNumber, rank: record.RankShort, LastName: record.LastName, Last4: record.Last4, date: record.LastDateTrained })
      }
    })
  })
  return unitTngRecords
}

function processPersReport (dtmsPersReport) {
  // count the unit size, also break down how many people by rank are in each unit
  // unitPersStats
  //  { 
  //    unit: UNIT_NAME,
  //    persCount: number,
  //    rankArray: [ {rank: count}, {rank: count}... ]
  //  }
  // iterate through the dtmsPersReport and print out unique units with a count of how many are in the unit

  // do two passes through the dtmsPersReport, on the first pass, get an array of all the different ranks inside the report
  let rankArray = []
  dtmsPersReport.forEach(function(person) {
    if(!rankArray.includes(person['RankShort'])) {
      rankArray.push(person['RankShort'])
    }
  })

  let rankArrayWithCount = []
  rankArray.forEach(function(rankVal) {
    rankArrayWithCount.push({ rank: rankVal, rankCount: 0 })
  })

  dtmsPersReport.forEach(function(person) {
    if(unitExists(person['UnitAssigned'])) {
      for (var i = 0; i < dtmsUnits.length; i++) {
        if (dtmsUnits[i].unit == person['UnitAssigned']) {
          dtmsUnits[i].persCount++
          if (person['RankShort'].indexOf('GS') >= 0) {
            dtmsUnits[i].civilianCount++
          }
          if (person['RankShort'].indexOf('GS') == -1) {
            dtmsUnits[i].soldierCount++
          }
          unitRankArray = dtmsUnits[i]['rankArray']
          // add 1 to the rankCount for the person's rank
          for (let j = 0; j < unitRankArray.length; j++) {
            if (unitRankArray[j]['rank'] === person['RankShort']) {
              unitRankArray[j]['rankCount']++
            }
          }
        }
      }
    } else {
      //dtmsUnits.push({ unit: person['UnitAssigned'], persCount: 1, rank: [{ person[]: 1}] })
      let unitRankArray = rankArrayWithCount.map(a => ({...a}))
      if (person['RankShort'].indexOf('GS') >= 0) {
        dtmsUnits.push(
          { 
            unit: person['UnitAssigned'], 
            persCount: 1,
            soldierCount: 0,
            civilianCount: 1,
            rankArray: unitRankArray
          })
      }
      if (person['RankShort'].indexOf('GS') == -1) {
        dtmsUnits.push(
          { 
            unit: person['UnitAssigned'], 
            persCount: 1,
            soldierCount: 1,
            civilianCount: 0,
            rankArray: unitRankArray
          })
      }
      // add the person's rank that entered the array
      for (let j = 0; j < unitRankArray.length; j++) {
        if (unitRankArray[j]['rank'] === person['RankShort']) {
          unitRankArray[j]['rankCount']++
        }
      }
    }
  })
  dtmsUnits = sortByUnit(dtmsUnits)
  return dtmsUnits
}


// count the personnel by unit
$('#displayUnitSize').on('click', function () {
  var scale = d3.scaleLinear()
    .domain([0,39])
    .range([0,600])

  d3.select(".chart")
    .selectAll("div")
    .data(dtmsUnits)
      .enter()
      .append("div")
      .style("width", function(d) { return scale(d.persCount) + 'px' })
      .text(function(d) { return d.unit + " Personnel: " + d.persCount })
})

// TODO - print out unit personnel



// print out the unit's percent compliance with each of the trainings listed in the training to track file
// make an easier way to view this information

// create a data structure that contains the units required training along with the numbers that they should have

// first sort the record
// by team, by person
$('#display350_1Compliance').on('click', function () {


  var tngToTrack = []
  dtmsTngToTrack.forEach(function(tngRow) {
    tngToTrack.push(tngRow['TaskNumber'])
  })

  // TODO - if there is no 'tngToTrack'

  //var tngToTrack = ['150S-SHA-0100', 'DA-CMT01', 'DA-CMT02', 'DA-CMT10', 'DA-CMT12', 'DA-CMT16', 'DA-CMT18', 'DA-CMT19', 'HQDA ALARACT 163/2014 (EEO-203A NS)', 'HQDA ALARACT 163/2014 (EEO-203B S)', 'ARCYBER-02', 'ARCYBER-03', 'ARCYBER-04', 'ARCYBER-07', 'ARCYBER-20', 'ARCYBER-21', 'ARCYBER-22', 'ARCYBER-23']

  
  unitTngRecords = calcTngCompliance(dtmsTngReport)
  //generate350_1Table(unitTngRecords, tngToTrack)
  generate350_1Table(unitTngRecords, dtmsTngToTrack)
})

// given an array of objects with property rank that contains the 'ShortRank' of the individual
// count the number of records that have 'GS' in their short rank
// we have GS-09 / GS-11 / GS-12 / GS-13 individuals
function countDACivilians (trainedPersonnel) {
  let dacCount = 0
  for (const item of trainedPersonnel) {
    if (item.rank.indexOf('GS') > 0) {
      dacCount++
    }
  }  
  return dacCount
}

function generate350_1Table (unitTngRecords, tngToTrack) {

  var complianceTable = document.getElementById('complianceTable')
  // remove the current table
  while(complianceTable.hasChildNodes()) {
     complianceTable.removeChild(complianceTable.firstChild);
  }

  // setup the header, get the trainings that need to be displayed
  
  var headerRowName = complianceTable.insertRow(-1)
  var headerRowNumber = complianceTable.insertRow(-1)
  var headerCellName = headerRowName.insertCell(-1)
  var headerCellNumber = headerRowNumber.insertCell(-1)
  for (var tng in tngToTrack) {
    headerCellName = headerRowName.insertCell(-1)
    headerCellName.innerHTML = tngToTrack[tng]['TaskName']
    headerCellNumber = headerRowNumber.insertCell(-1)
    headerCellNumber.innerHTML = tngToTrack[tng]['TaskNumber']
  }

  for (var unit in unitTngRecords) {
    var unitRow = complianceTable.insertRow(-1)
    var unitCell = unitRow.insertCell(-1)
    unitCell.innerHTML = unitTngRecords[unit]['unit']
    for (var tng in tngToTrack) {
      unitCell = unitRow.insertCell(-1)
      //unitCell.innerHTML = tngToTrack[tng]
      var cellId = 'complianceTableCell' + unit + tng
      unitCell.id = cellId
      var data = getUnitCompliance(tngToTrack[tng]['TaskNumber'], unitTngRecords[unit]['unit'], tngToTrack[tng]['Audience'])
      // set the chart up here, 
      setCellCompliance(unitCell, data)
      let tngVal = tngToTrack[tng]['TaskNumber']
      let unitVal = unitTngRecords[unit]['unit']
      unitCell.onclick = (function(){genAndShowTngList(tngVal, unitVal)})
      //var data = {compliant: 5, noncompliant: 10}
      //generateDonutChart(data, '#' + cellId)
    }
  }
}

function generateTngList (tng, unit) {
  // iterate through and display who is compliant and who is not compliant with that training
  let personRecords = []

  dtmsPersReport.forEach(function(personRecord) {
    if (personRecord['UnitAssigned'] === unit) {
      personRecords.push(personRecord)
    }
  })
  dtmsTngReport.forEach(function(record) {
    personRecords.forEach(function(person) {
      if (record['TaskNumber'] === tng && record['Last4'] === person['Last4'] && record['LastName'] === person['LastName']) {
        person['LastDateTrained'] = record['LastDateTrained']
        person['TaskNumber'] = record['TaskNumber']
      }
    })
  })
  return personRecords
}

function genAndShowTngList(tng, unit) {
  let personRecords = generateTngList(tng, unit)
  showTngList(personRecords)
}


function showTngList (personRecords) {
  var personTable = document.getElementById('personTable')
  // remove the current table
  while(personTable.hasChildNodes()) {
     personTable.removeChild(personTable.firstChild);
  }
  let headerRow = personTable.insertRow(-1)
  let rankHeaderCell = headerRow.insertCell(-1)
  rankHeaderCell.innerHTML = 'Rank'
  let nameHeaderCell = headerRow.insertCell(-1)
  nameHeaderCell.innerHTML = 'Name'
  let tngHeaderCell = headerRow.insertCell(-1)
  tngHeaderCell.innerHTML = 'Training'
  let tngDateHeaderCell = headerRow.insertCell(-1)
  tngDateHeaderCell.innerHTML = 'Date Trained'
  personRecords.forEach(function(person) {
    let personRow = personTable.insertRow(-1)
    let personRankCell = personRow.insertCell(-1)
    let personNameCell = personRow.insertCell(-1)
    let personTngCell = personRow.insertCell(-1)
    let personTngDateCell = personRow.insertCell(-1)
    personRankCell.innerHTML = person.RankShort
    personNameCell.innerHTML = person.LastName
    if (person.TaskNumber !== undefined) { 
      personTngCell.innerHTML = person.TaskNumber
    } else {
      personTngCell.innerHTML = ''
    }
    if (person.LastDateTrained !== undefined) {
      personTngDateCell.innerHTML = person.LastDateTrained
    } else {
      personTngDateCell.innerHTML = ''
    }
  })
}



function setCellCompliance (cell, values) {
  let compliant = parseInt(values.compliant)
  let total = parseInt(values.compliant) + parseInt(values.noncompliant)
  let compliance = Math.round(100 * compliant / total)
  cell.innerHTML = compliance + '%<br>' + compliant + '/' + total

  if(compliance < 70) {
    cell.bgColor = 'red'
    cell.style.color = 'white'
  } else if (compliance < 80) {
    cell.bgColor = 'yellow'
    cell.style.color = 'black'
  } else {
    cell.bgColor = 'green'
    cell.style.color = 'black'
  }
}

function getUnitCompliance(tng, unit, audience) {
  // total the number of people that have completed the training, return an
  // object { compliant: VALUE, noncompliant: VALUE }
  var personRecords = []
  var peopleInUnit = 0
  for (var unitVal in unitTngRecords) {
    if (unit == unitTngRecords[unitVal]['unit']) {
      personRecords = unitTngRecords[unitVal]['tngData'][tng] || []
      peopleInUnit = unitTngRecords[unitVal]['persCount']
    }
  }
  // TODO first sort the array by the date of the training to ensure that the most recent training is highest
  // remove duplicates from the 'personReocrds' field
  var dedupPersonRecords = []
  const map = new Map()
  for (const item of personRecords) {
    if(!map.has(item.Last4)) {
      map.set(item.Last4, true)
      dedupPersonRecords.push({
            LastName: item.LastName,
            Last4: item.Last4
      })
    }
  }
  // need to make sure there are no duplicate records in the future
  try {
    var compliant = dedupPersonRecords.length
  } catch (e) {
    compliant = 0
  }
  // 4 cases
  // 1 - all -> just use 'peopleInUnit'
  // 2 - Soldiers -> subtrack civilians from people in unit
  // 3 - Civilians -> use the civilians number
  // 4 - Supervisors -> hard code in '2' at this time

  var required = peopleInUnit

  if (audience === 'All') {
    required = peopleInUnit
  } else if (audience === 'Soldiers') {
    var unitSoldierCount = getSoldierCount(unit)
    required = unitSoldierCount
  } else if (audience === 'Civilians') {
    var unitCivilianCount = getCivilianCount(unit)
    required = unitCivilianCount
  } else if (audience === 'Supervisors') {
    required = 2
  } else {
    required = peopleInUnit
  }

  let noncompliant = 0
  if (required - compliant > 0) {
    noncompliant = required - compliant
  }
  // TODO - check to make sure that those that are required to take a training are the ones that completed it
  return { compliant: compliant, noncompliant: noncompliant }
}

function getSoldierCount (unit) {
  var soldierCount = 0
  dtmsUnits.forEach(function(dtmsUnit) {
    if (dtmsUnit['unit'] === unit) {
      soldierCount = dtmsUnit['soldierCount']
    }
  })
  return soldierCount
}

function getCivilianCount (unit) {
  var civilianCount = 0
  dtmsUnits.forEach(function(dtmsUnit) {
    if (dtmsUnit['unit'] === unit) {
      civilianCount = dtmsUnit['civilianCount']
    }
  })
  return civilianCount
}

// sort by the date column descending (newest value on the top)
function sortByDateDesc (sort_file) {
  // sort by the unit
  sort_file.sort( function(a, b) {
    return (a.unit.localeCompare(b.unit))
  })
  return sort_file
}

function sortByUnit (sort_file) {
  // sort by the unit
  sort_file.sort( function(a, b) {
    return (a.unit.localeCompare(b.unit))
  })
  return sort_file
}

function unitExists(unitName) {
  return dtmsUnits.some(function(el) {
    return el.unit === unitName
  })  
}


function generateDonutChart (data, divId)  {
  var width = 100
  var height = 100
  var margin = 10

  var radius = Math.min(width, height) / 2 - margin

  var percent = Math.round(data.compliant * 100 / (data.compliant + data.noncompliant))
  
  //var svg = d3.select(".tngComplianceChart")
  var svg = d3.select(divId)
  .append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")

  svg.append("text")
    .attr("text-anchor", "middle")
    .text(percent + '%')

  // set the color scale
  var color = d3.scaleOrdinal()
    .domain(data)
    .range(["#00b050", "#ff0000"])

  // Compute the position of each group on the pie:
  var pie = d3.pie()
    .value(function(d) {return d.value; })
  var data_ready = pie(d3.entries(data))


  // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
  svg
    .selectAll('whatever')
    .data(data_ready)
    .enter()
    .append('path')
    .attr('d', d3.arc()
      .innerRadius(radius/2)
      .outerRadius(radius)
    )
    .attr('fill', function(d){ return(color(d.data.key)) })
    .attr("stroke", "black")
    .style("stroke-width", "2px")
    .style("opacity", 0.7)

}

</script>
</body>
</html>
